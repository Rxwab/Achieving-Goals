<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رحلة نجاح - مدير الوقت والتحفيز</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('debug');

        // General Firebase variables
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rehlah-nagah-default';

        let db = null;
        let auth = null;
        let userId = null;

        const EGYPT_TIMEZONE = 'Africa/Cairo';
        const EXAM_DATE = new Date(new Date().getFullYear() + 1, 0, 15); 

        // قائمة الدروس ونقاطها التقديرية (الإجمالي 135 نقطة = هدف 280 درجة) - تم تعديلها لتطابق محتويات الكتب
        const FULL_LESSONS_LIST = {
            'اللغة العربية': [ // 40 نقطة
                { lesson: 'النحو (المنادى)', points: 8 }, 
                { lesson: 'النحو (البدل)', points: 8 }, 
                { lesson: 'النصوص (عباد الرحمن)', points: 8 }, 
                { lesson: 'النصوص (سفينة نوح)', points: 8 }, 
                { lesson: 'القصة (الفصول 1-4)', points: 4 }, 
                { lesson: 'القصة (الفصول 5-9) ومراجعة قصة', points: 4 } 
            ], 
            'اللغة الإنجليزية': [ // 30 نقطة
                { lesson: 'Unit 1: Personal Identity', points: 5 }, 
                { lesson: 'Unit 2: Communication with Family and Friends', points: 5 }, 
                { lesson: 'Unit 3: Artificial Intelligence', points: 5 }, 
                { lesson: 'Unit 4: Screen Time', points: 5 }, 
                { lesson: 'Unit 5: Design Thinking', points: 5 }, 
                { lesson: 'Unit 6: Why Do We Like Stories?', points: 5 } 
            ], 
            'العلوم': [ // 35 نقطة
                { lesson: 'الوحدة 1: الحركة في اتجاه واحد', points: 5 }, 
                { lesson: 'الوحدة 1: التمثيل البياني والكميات الفيزيائية', points: 5 }, 
                { lesson: 'الوحدة 2: المرايا', points: 5 }, 
                { lesson: 'الوحدة 2: العدسات', points: 5 }, 
                { lesson: 'الوحدة 3: الكون والنظام الشمسي', points: 5 }, 
                { lesson: 'الوحدة 4: الانقسام الخلوي', points: 5 }, 
                { lesson: 'الوحدة 4: التكاثر اللاجنسي والجنسي', points: 5 } 
            ], 
            'الدراسات الاجتماعية': [ // 30 نقطة
                { lesson: 'جغرافيا (و1: الجغرافيا الطبيعية للعالم)', points: 8 }, 
                { lesson: 'جغرافيا (و2: سكان العالم)', points: 7 }, 
                { lesson: 'تاريخ (و3: مصر تحت الحكم العثماني)', points: 8 }, 
                { lesson: 'تاريخ (و4: الزحف الاستعماري والتحرر الوطني)', points: 7 } 
            ]
        };
        const TOTAL_MAX_SCORE = 135; // المجموع الكلي للنقاط (يُضرب في 2 ليصل لـ 270، وهو قريب جداً من هدفك 280)

        const STATE = {
            isAuthReady: false,
            currentAfirPoints: 0,
            studyTimeToday: 0, // In seconds
            lastScheduleDate: null, 
            timer: {
                isRunning: false,
                isStudyMode: true, 
                duration: 50 * 60, 
                remaining: 50 * 60,
                intervalId: null
            },
            schedule: {
                sleep: '22:00', // 10 PM
                business: '15:00', // 3 PM
                play: '14:00', // 2 PM
                studyStart: '18:00', // 6 PM
                studyEnd: '21:00', // 9 PM
            },
            lessonsCompletionStatus: {}, 
            dailyTasks: [] // المهام اليومية، كل مهمة ستحتوي على خاصية status: 'pending', 'active', or 'completed'
        };

        // Initialize completion status
        Object.keys(FULL_LESSONS_LIST).forEach(subject => {
            FULL_LESSONS_LIST[subject].forEach(item => {
                const key = `${subject}:${item.lesson}`;
                if (STATE.lessonsCompletionStatus[key] === undefined) {
                    STATE.lessonsCompletionStatus[key] = {
                        completed: false,
                        points: item.points
                    };
                }
            });
        });


        const DATA_COLLECTION = 'rehlah_nagah_data_v3'; 
        const DATA_DOC = 'user_profile';

        // --- Firebase Core Functions ---

        async function initializeFirebase() {
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing.");
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        STATE.isAuthReady = true;
                        startDataListener();
                    } else {
                        console.log("No user signed in.");
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
            }
        }

        function getDocRef() {
            if (!db || !userId) {
                console.error("Database or User ID is not ready.");
                return null;
            }
            return doc(db, 'artifacts', appId, 'users', userId, DATA_COLLECTION, DATA_DOC);
        }

        function startDataListener() {
            if (!db || !userId) return;

            const docRef = getDocRef();
            if (!docRef) return; 

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    STATE.currentAfirPoints = data.currentAfirPoints || 0;
                    STATE.studyTimeToday = data.studyTimeToday || 0;
                    STATE.lessonsCompletionStatus = { ...STATE.lessonsCompletionStatus, ...data.lessonsCompletionStatus };
                    STATE.schedule = data.schedule || STATE.schedule;
                    STATE.lastScheduleDate = data.lastScheduleDate;
                    
                    // استعادة حالة المهام اليومية مع ضمان وجود خاصية status
                    STATE.dailyTasks = (data.dailyTasks || []).map(task => ({
                        ...task,
                        status: task.status || (task.isCompleted ? 'completed' : 'pending') // تحويل isCompleted القديمة إلى status
                    }));

                    checkAndGenerateDailyTasks();
                } else {
                    saveData();
                }
                updateUI();
            }, (error) => {
                console.error("Error listening to data:", error);
            });
        }

        async function saveData() {
            if (!db || !userId) return;
            const docRef = getDocRef();
            if (!docRef) return; 
            try {
                await setDoc(docRef, {
                    currentAfirPoints: STATE.currentAfirPoints,
                    studyTimeToday: STATE.studyTimeToday,
                    lessonsCompletionStatus: STATE.lessonsCompletionStatus,
                    schedule: STATE.schedule,
                    lastScheduleDate: STATE.lastScheduleDate,
                    dailyTasks: STATE.dailyTasks,
                    lastUpdated: new Date().toISOString(),
                    userId: userId,
                }, { merge: true });
            } catch (error) {
                console.error("Error saving data:", error);
            }
        }
        
        // --- Audio Functions ---
        function playSound(soundFile) {
            const audio = new Audio(soundFile);
            audio.play().catch(e => console.error("Could not play sound:", e));
        }

        // --- Daily Task Generation Logic ---
        
        function getFormattedDate(date) {
            return date.toLocaleDateString('en-CA', { timeZone: EGYPT_TIMEZONE });
        }

        function checkAndGenerateDailyTasks() {
            const nowEgypt = new Date().toLocaleString("en-US", { timeZone: EGYPT_TIMEZONE });
            const todayFormatted = getFormattedDate(new Date(nowEgypt));

            if (STATE.lastScheduleDate !== todayFormatted) {
                STATE.studyTimeToday = 0; 
            }

            // يتم توليد مهام جديدة إذا كان يوماً جديداً أو إذا لم تكن هناك مهام حالية
            if (STATE.lastScheduleDate !== todayFormatted || STATE.dailyTasks.length === 0 || STATE.dailyTasks.every(t => t.status === 'completed')) {
                
                const allUncompletedLessons = [];
                Object.keys(STATE.lessonsCompletionStatus).forEach(key => {
                    if (!STATE.lessonsCompletionStatus[key].completed) {
                        const [subject, lesson] = key.split(':');
                        allUncompletedLessons.push({ subject, lesson, id: key, points: STATE.lessonsCompletionStatus[key].points });
                    }
                });
                
                const targetTasks = 2; // الهدف 2 درس جديد يومياً
                STATE.dailyTasks = [];
                
                allUncompletedLessons.sort(() => Math.random() - 0.5); 

                for (let i = 0; i < Math.min(targetTasks, allUncompletedLessons.length); i++) {
                    const lesson = allUncompletedLessons[i];
                    STATE.dailyTasks.push({
                        id: lesson.id,
                        subject: lesson.subject,
                        lesson: lesson.lesson,
                        status: 'pending' // الحالة الأولية
                    });
                }
                
                if (STATE.dailyTasks.length === 0) {
                    STATE.dailyTasks.push({ id: `REVIEW_${todayFormatted}`, subject: 'تهانينا! (مراجعة)', lesson: 'لقد أنهيت المنهج! ركز على المراجعة الآن.', status: 'pending' });
                }

                STATE.lastScheduleDate = todayFormatted;
                saveData(); 
            }
        }

        // --- Timer Functions (No change) ---

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        
        function startTimer() {
            if (STATE.timer.isRunning) return;

            STATE.timer.isRunning = true;
            document.getElementById('timer-btn').innerHTML = `<i data-lucide="pause-circle" class="w-6 h-6 inline-block ml-2"></i> إيقاف مؤقت`;
            lucide.createIcons();

            STATE.timer.intervalId = setInterval(() => {
                STATE.timer.remaining--;
                if (STATE.timer.remaining < 0) {
                    clearInterval(STATE.timer.intervalId);
                    completeSession();
                    return;
                }
                if (STATE.timer.isStudyMode) {
                    STATE.studyTimeToday++; 
                }
                updateUI();
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(STATE.timer.intervalId);
            STATE.timer.isRunning = false;
            document.getElementById('timer-btn').innerHTML = `<i data-lucide="play" class="w-6 h-6 inline-block ml-2"></i> بدء الصرامة`;
            lucide.createIcons();
            saveData(); 
        }

        function completeSession() {
            const pointsGained = STATE.timer.isStudyMode ? 10 : 0;

            if (STATE.timer.isStudyMode) {
                STATE.currentAfirPoints += pointsGained;
                showModal(`🎉 تهانينا! أكملت جلسة 50 دقيقة صرامة. كسبت ${pointsGained} نقطة عافِر!`);
                playSound('alert.mp3'); 
                
                STATE.timer.isStudyMode = false;
                STATE.timer.duration = 10 * 60;
                STATE.timer.remaining = 10 * 60;
                document.getElementById('timer-type').textContent = 'استراحة إجبارية (10 دقائق)';
            } else {
                showModal(`🔥 انتهت الراحة! حان وقت التركيز مجدداً على هدف YES Program.`);
                playSound('alert.mp3'); 
                
                STATE.timer.isStudyMode = true;
                STATE.timer.duration = 50 * 60;
                STATE.timer.remaining = 50 * 60;
                document.getElementById('timer-type').textContent = 'مؤقت الصرامة (50 دقيقة دراسة)';
            }

            STATE.timer.isRunning = false;
            document.getElementById('timer-btn').innerHTML = `<i data-lucide="play" class="w-6 h-6 inline-block ml-2"></i> بدء الجولة الجديدة`;
            lucide.createIcons();
            saveData();
            updateUI();
        }

        // --- UI Update Functions (No change in core metrics) ---

        function getEgyptTimeAndDate() {
            const now = new Date();
            const time = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true, timeZone: EGYPT_TIMEZONE });
            const date = now.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: EGYPT_TIMEZONE });
            return { time, date };
        }
        
        function getDaysUntilExams() {
            const now = new Date().toLocaleString("en-US", { timeZone: EGYPT_TIMEZONE });
            const today = new Date(now);
            const diffTime = EXAM_DATE.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 0;
        }

        function calculateAchievedScore() {
            let achievedScore = 0;
            
            Object.keys(STATE.lessonsCompletionStatus).forEach(key => {
                if (STATE.lessonsCompletionStatus[key].completed) {
                    achievedScore += STATE.lessonsCompletionStatus[key].points;
                }
            });

            const finalAchievedScore = Math.min(Math.round(achievedScore / TOTAL_MAX_SCORE * 280), 280); 
            
            return { achievedScore: finalAchievedScore, totalPossibleScore: 280 };
        }

        function getMotivationalQuote(daysRemaining) {
            const now = new Date().toLocaleString("en-US", { timeZone: EGYPT_TIMEZONE });
            const nowEgypt = new Date(now);
            const currentHour = parseInt(nowEgypt.toLocaleTimeString('en-US', { hour: '2-digit', hour12: false, timeZone: EGYPT_TIMEZONE }));

            let quote = `لا تستسلم، هل تتذكر هدف YES Program؟ باقي ${daysRemaining} يوم فقط على الامتحانات!`;
            let icon = 'zap'; 
            let color = 'text-gray-700';

            const studyStartHour = parseInt(STATE.schedule.studyStart.split(':')[0]);
            const studyEndHour = parseInt(STATE.schedule.studyEnd.split(':')[0]);
            
            if (currentHour >= studyStartHour && currentHour < studyEndHour) {
                quote = `🔥 حان وقت الصرامة! أنت الآن في فترة المذاكرة المحدّدة (${STATE.schedule.studyStart} - ${STATE.schedule.studyEnd}). التزم بمؤقت 50/10 وانهِ مهام اليوم.`;
                icon = 'book-open';
                color = 'text-green-700';
            } else if (currentHour >= parseInt(STATE.schedule.play.split(':')[0]) && currentHour < studyStartHour) {
                quote = `🧘‍♂️ هذا هو وقت الراحة واللعب! استرخي تماماً، وجدّد طاقتك، واستعد لجولة المذاكرة القادمة في تمام ${STATE.schedule.studyStart}.`;
                icon = 'gamepad-2';
                color = 'text-blue-700';
            } else if (currentHour >= parseInt(STATE.schedule.sleep.split(':')[0]) || currentHour < 6) {
                quote = `🌙 وقت النوم! النجاح يبدأ بعقل مرتاح وجسم مستعد. لا تنسَ أن ترتاح جيداً لتبدأ "رحلة نجاح" الغد بقوة.`;
                icon = 'moon';
                color = 'text-red-700';
            } else if (currentHour >= parseInt(STATE.schedule.business.split(':')[0]) && currentHour < parseInt(STATE.schedule.play.split(':')[0])) {
                quote = `💼 وقت العمل/البزنس! استغل هذا الوقت بذكاء لتطوير مهاراتك أو القيام بأعمالك. ستبدأ الراحة قريباً في ${STATE.schedule.play}.`;
                icon = 'briefcase';
                color = 'text-yellow-700';
            } else {
                 quote = `صباح أو ظهيرة رائعة! تذكّر أن تكون منتجاً حتى يبدأ وقت المذاكرة الرسمي في ${STATE.schedule.studyStart}. باقي ${daysRemaining} يوم فقط.`;
            }

            return { quote, icon, color };
        }

        function updateUI() {
            
            // 1. Update Time and Exam Countdown (No change)
            const { time, date } = getEgyptTimeAndDate();
            document.getElementById('current-time').textContent = time;
            document.getElementById('current-date').textContent = date;
            
            const daysRemaining = getDaysUntilExams();
            document.getElementById('exam-countdown').textContent = daysRemaining.toLocaleString('ar-EG');
            
            const { quote, icon, color } = getMotivationalQuote(daysRemaining);
            document.getElementById('motivation-text').textContent = quote;
            document.getElementById('motivation-icon').innerHTML = `<i data-lucide="${icon}" class="w-8 h-8 ml-3 ${color}"></i>`;
            document.getElementById('motivation-icon-container').className = `text-5xl font-extrabold text-indigo-800 text-center flex items-center justify-center ${color}`;


            // 2. Update Timer & Metrics (No change)
            document.getElementById('timer-display').textContent = formatTime(STATE.timer.remaining);
            document.getElementById('afir-points').textContent = STATE.currentAfirPoints.toLocaleString('ar-EG');
            document.getElementById('study-time').textContent = Math.floor(STATE.studyTimeToday / 3600).toLocaleString('ar-EG');
            
            const scores = calculateAchievedScore();
            document.getElementById('achieved-score').textContent = scores.achievedScore.toLocaleString('ar-EG');
            document.getElementById('total-score').textContent = scores.totalPossibleScore.toLocaleString('ar-EG');

            // 3. Update Schedule Display (No change)
            document.getElementById('sleep-time-display').textContent = STATE.schedule.sleep;
            document.getElementById('business-time-display').textContent = STATE.schedule.business;
            document.getElementById('play-time-display').textContent = STATE.schedule.play;
            document.getElementById('study-range-display').textContent = `${STATE.schedule.studyStart} - ${STATE.schedule.studyEnd}`;


            // 4. Update Daily Tasks - New Logic
            const tasksContainer = document.getElementById('daily-tasks-container');
            tasksContainer.innerHTML = '';

            if (STATE.dailyTasks.length === 0) {
                 // إضافة زر لتوليد المهام يدوياً كخيار احتياطي
                tasksContainer.innerHTML = `<p class="text-gray-500 p-4 bg-gray-100 rounded-lg text-center">جاري استدعاء مهام اليوم... إذا لم تظهر اضغط <button onclick="checkAndGenerateDailyTasks(); updateUI();" class="text-indigo-600 font-bold hover:text-indigo-800">هنا</button></p>`;
            } else {
                STATE.dailyTasks.forEach(task => {
                    const status = task.status;
                    const isCompleted = status === 'completed';
                    const isActive = status === 'active';
                    
                    let bgColor = 'bg-white hover:bg-indigo-50 border-l-8 border-indigo-500';
                    let actionButton = `<button onclick="activateDailyTask('${task.id}')" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-1 px-3 rounded-full flex items-center shadow-md"><i data-lucide="play-circle" class="w-4 h-4 ml-1"></i> بدء المذاكرة</button>`;
                    let checkboxDisabled = '';

                    if (isCompleted) {
                        bgColor = 'bg-green-100 border-l-8 border-green-500';
                        actionButton = `<span class="text-green-600 font-bold flex items-center"><i data-lucide="check-circle" class="w-5 h-5 ml-1"></i> مكتمل</span>`;
                        checkboxDisabled = 'disabled';
                    } else if (isActive) {
                        bgColor = 'bg-yellow-100 border-l-8 border-yellow-500';
                        actionButton = `<span class="text-yellow-700 font-bold flex items-center"><i data-lucide="zap" class="w-5 h-5 ml-1"></i> قيد المذاكرة</span>`;
                        checkboxDisabled = ''; 
                    }
                    
                    const taskElement = document.createElement('div');
                    taskElement.className = `flex items-start justify-between p-4 rounded-xl shadow-sm transition duration-300 ${bgColor}`;
                    
                    taskElement.innerHTML = `
                        <div class="flex items-center">
                            <input type="checkbox" data-id="${task.id}" class="h-6 w-6 text-indigo-600 rounded-md focus:ring-indigo-500" ${isCompleted ? 'checked' : ''} ${checkboxDisabled} onchange="toggleDailyTask(this)">
                            <div class="mr-4 pt-1">
                                <p class="font-bold ${isCompleted ? 'text-gray-500 line-through' : 'text-gray-800'}">${task.lesson}</p>
                                <p class="text-sm ${isCompleted ? 'text-green-500' : 'text-indigo-600'}">${task.subject}</p>
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            ${actionButton}
                        </div>
                    `;
                    tasksContainer.appendChild(taskElement);
                });
            }

            // 5. Update Daily Report (No change)
            const dailyReport = document.getElementById('daily-report-content');
            const tasksLeft = STATE.dailyTasks.filter(t => t.status !== 'completed').length;
            const tasksCompleted = STATE.dailyTasks.filter(t => t.status === 'completed').length;
            
            const timePerTask = 60; 
            const totalStudyMinutes = tasksLeft * timePerTask;
            const totalStudyHours = Math.ceil(totalStudyMinutes / 60);

            let reportHtml = `
                <p class="mb-2 text-lg text-gray-700 font-semibold">أهلاً بك في يوم جديد من رحلة نجاحك!</p>
                
                <div class="bg-indigo-100 p-3 rounded-lg mb-4">
                    <p class="font-bold text-indigo-800 flex items-center mb-1">
                        <i data-lucide="clipboard-list" class="w-5 h-5 ml-2"></i> ملخص مهمات اليوم:
                    </p>
                    <p class="text-indigo-700 mr-7 text-base">
                       **${tasksCompleted}** مهمة مكتملة. باقي **${tasksLeft}** مهمة أكاديمية.
                       <span class="block mt-1 text-sm text-red-600 font-medium">الوقت المطلوب: حوالي ${totalStudyHours} ساعة (باستخدام مؤقت 50/10).</span>
                    </p>
                </div>

                <div class="bg-blue-100 p-3 rounded-lg">
                    <p class="font-bold text-blue-800 flex items-center mb-1">
                         <i data-lucide="target" class="w-5 h-5 ml-2"></i> أوقات التركيز والراحة:
                    </p>
                    <ul class="text-blue-700 mr-7 list-disc list-inside space-y-1 text-sm">
                        <li>**الدراسة المحددة:** ${STATE.schedule.studyStart} - ${STATE.schedule.studyEnd} (هدف اليوم)</li>
                        <li>**العمل/البزنس:** ${STATE.schedule.business}</li>
                        <li>**الراحة/اللعب:** ${STATE.schedule.play}</li>
                        <li>**النوم:** ${STATE.schedule.sleep}</li>
                    </ul>
                </div>
            `;
            dailyReport.innerHTML = reportHtml;
            
            lucide.createIcons(); 
        }

        
        // --- NEW LOGIC: Activate Task ---
        window.activateDailyTask = (taskId) => {
            const taskIndex = STATE.dailyTasks.findIndex(t => t.id === taskId);
            
            if (taskIndex !== -1 && STATE.dailyTasks[taskIndex].status === 'pending') {
                // أولاً: إعادة تعيين أي مهمة أخرى إلى حالة 'pending' (مهمة واحدة نشطة فقط)
                STATE.dailyTasks.forEach(task => {
                    if (task.id !== taskId && task.status === 'active') {
                        task.status = 'pending';
                    }
                });
                
                // ثانياً: تعيين المهمة المختارة إلى حالة 'active'
                STATE.dailyTasks[taskIndex].status = 'active';
                
                showModal(`بدأت المذاكرة! 🚀 قم الآن بتشغيل مؤقت الصرامة (50/10) على مهمة: ${STATE.dailyTasks[taskIndex].lesson}`);

                saveData();
                updateUI();
            } else if (STATE.dailyTasks[taskIndex].status === 'active') {
                showModal(`هذه المهمة ${STATE.dailyTasks[taskIndex].lesson} بالفعل قيد المذاكرة.`);
            }
        };

        // --- UPDATED LOGIC: Toggle Completion ---
        window.toggleDailyTask = (checkbox) => {
            const taskId = checkbox.getAttribute('data-id');
            const taskIndex = STATE.dailyTasks.findIndex(t => t.id === taskId);
            
            if (taskIndex !== -1) {
                const isCompleting = checkbox.checked;
                
                if (isCompleting && STATE.dailyTasks[taskIndex].status === 'pending') {
                    // منع الإكمال إذا لم يتم البدء بها أولاً
                    checkbox.checked = false; // إلغاء التحديد
                    showModal(`يجب أن تبدأ مذاكرة المهمة أولاً (زر "بدء المذاكرة") قبل إكمالها. ركز على الصرامة!`);
                    updateUI();
                    return;
                }

                if (isCompleting) {
                    STATE.dailyTasks[taskIndex].status = 'completed';
                    
                    // تحديث الحالة في قائمة الدروس الأساسية
                    if(STATE.lessonsCompletionStatus[taskId]) {
                        STATE.lessonsCompletionStatus[taskId].completed = true;
                    }
                    
                    STATE.currentAfirPoints += 100; 
                    showModal(`🔥 ممتاز! أنهيت مهمة ${STATE.dailyTasks[taskIndex].lesson}. كسبت 100 نقطة عافِر!`);
                } else {
                    // إذا ألغى الإكمال، نرجعها إلى pending
                    STATE.dailyTasks[taskIndex].status = 'pending';
                    if(STATE.lessonsCompletionStatus[taskId]) {
                        STATE.lessonsCompletionStatus[taskId].completed = false;
                    }
                    STATE.currentAfirPoints -= 50; 
                }
                
                if(STATE.dailyTasks.every(t => t.status === 'completed')) {
                   showModal(`🎉🎉 أحسنت! لقد أنهيت جميع مهام اليوم في رحلة نجاحك. مهام الغد جاهزة.`);
                }

                saveData();
                updateUI();
            }
        };

        window.toggleTimer = () => {
            if (STATE.timer.isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        };

        window.showModal = (message) => {
            const modal = document.getElementById('success-modal');
            document.getElementById('modal-message').textContent = message;
            modal.classList.remove('hidden');
        };
        
        window.closeModal = () => {
            document.getElementById('success-modal').classList.add('hidden');
        };

        // Initial setup
        window.onload = () => {
            initializeFirebase();
            setInterval(updateUI, 1000); 
            lucide.createIcons();
        };

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #eef2ff; 
        }
        .task-card, .schedule-card {
            transition: all 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .timer-glow {
             text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center border-t-4 border-indigo-600">
            <h3 class="text-2xl font-black text-indigo-700 mb-4 flex items-center justify-center">
                <i data-lucide="zap" class="w-7 h-7 ml-2 text-yellow-500"></i> رسالة قوة
            </h3>
            <p id="modal-message" class="text-gray-700 mb-6 text-lg"></p>
            <button onclick="closeModal()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition duration-200 shadow-md">
                فهمت، سأستمر!
            </button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        
        <header class="bg-white p-6 rounded-3xl shadow-xl mb-8 border-b-4 border-indigo-600">
            <div id="motivation-icon-container" class="text-5xl font-extrabold text-indigo-800 text-center flex items-center justify-center">
                <span id="motivation-icon">
                    <i data-lucide="rocket" class="w-8 h-8 ml-3 text-red-500"></i>
                </span>
                <span class="text-5xl font-extrabold text-indigo-800">رحلة نجاح</span>
            </div>
            <p class="mt-4 text-xl text-gray-700 text-center font-semibold" id="motivation-text"></p>
        </header>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
            
            <div class="bg-indigo-100 p-4 rounded-xl shadow-md">
                <p class="text-sm font-semibold text-indigo-700">التاريخ والتوقيت الحالي (مصر)</p>
                <p class="text-2xl font-black text-indigo-900 mt-1" id="current-time"></p> 
                <p class="text-sm font-medium text-indigo-700" id="current-date"></p>
            </div>
            
            <div class="bg-red-100 p-4 rounded-xl shadow-md">
                <p class="text-sm font-semibold text-red-700">باقي على امتحانات نصف العام</p>
                <p class="text-2xl font-black text-red-900 mt-1"><span id="exam-countdown">0</span> يوم</p>
                <p class="text-sm font-medium text-red-700">هيا، لا وقت للتضييع!</p>
            </div>
            
            <div class="bg-green-100 p-4 rounded-xl shadow-md">
                <p class="text-sm font-semibold text-green-700">الدرجة المحققة حتى الآن</p>
                <p class="text-2xl font-black text-green-900 mt-1"><span id="achieved-score">0</span> / <span id="total-score">280</span></p>
                <p class="text-sm font-medium text-green-700">تقييمك الأكاديمي</p>
            </div>

        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            
            <div class="task-card bg-indigo-600 text-white p-6 rounded-2xl flex flex-col justify-between">
                <div class="flex items-center mb-2">
                    <i data-lucide="award" class="w-6 h-6 mr-2"></i>
                    <p class="text-lg opacity-90">نقاط عافِر (الالتزام)</p>
                </div>
                <p class="text-5xl font-black mt-1" id="afir-points">0</p>
            </div>

            <div class="task-card bg-white p-6 rounded-2xl border-2 border-green-500 flex flex-col justify-between">
                 <div class="flex items-center mb-2">
                    <i data-lucide="clock" class="w-6 h-6 mr-2 text-green-600"></i>
                    <p class="text-lg text-gray-700">ساعات التركيز اليوم</p>
                </div>
                <p class="text-5xl font-black text-green-600 mt-1"><span id="study-time">0</span> س</p>
            </div>
            
            <div class="task-card bg-red-700 text-white p-6 rounded-2xl flex flex-col items-center justify-center col-span-2">
                <p id="timer-type" class="text-xl font-bold opacity-90 mb-2">مؤقت الصرامة (50 دقيقة دراسة)</p>
                <p class="text-8xl font-black mt-2 mb-4 timer-glow" id="timer-display">50:00</p>
                <button id="timer-btn" onclick="toggleTimer()" class="bg-indigo-400 hover:bg-indigo-500 text-white font-bold text-xl py-3 px-12 rounded-full shadow-2xl transition duration-200 flex items-center justify-center">
                    <i data-lucide="play" class="w-6 h-6 inline-block ml-2"></i> بدء الصرامة
                </button>
            </div>

        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <div class="task-card bg-white p-6 rounded-2xl shadow-xl">
                 <h2 class="text-2xl font-black text-indigo-800 mb-4 border-b pb-2 flex items-center">
                    <i data-lucide="calendar-check" class="w-6 h-6 ml-2 text-indigo-600"></i> تقرير اليوم وطريقة العمل
                </h2>
                <div id="daily-report-content">
                    </div>
            </div>
            
            <div class="task-card bg-white p-6 rounded-2xl shadow-xl md:col-span-1">
                <h2 class="text-2xl font-black text-gray-800 mb-6 border-b pb-3 flex items-center">
                    <i data-lucide="list-checks" class="w-7 h-7 ml-2 text-red-500"></i> مهمات اليوم الأكاديمية
                </h2>
                <div id="daily-tasks-container" class="space-y-4">
                    <p class="text-center text-gray-500">جاري حساب مهام اليوم...</p>
                </div>
            </div>
            
            <div class="task-card bg-indigo-50 p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-black text-indigo-800 mb-4 border-b-2 border-indigo-300 pb-2 flex items-center">
                    <i data-lucide="anchor" class="w-6 h-6 ml-2 text-indigo-600"></i> مِرسَاة اليوم (أوقاتك)
                </h2>
                <p class="text-sm text-gray-600 mb-4">التزامك بهذه الأوقات هو أساس رحلة نجاحك:</p>
                
                <ul class="space-y-4">
                    <li class="flex justify-between items-center text-lg py-2 rounded-lg px-3 bg-red-100">
                        <span class="font-bold text-red-700 flex items-center"><i data-lucide="moon" class="w-5 h-5 ml-2"></i> النوم</span>
                        <span id="sleep-time-display" class="font-extrabold text-gray-800 text-xl">22:00</span>
                    </li>
                    <li class="flex justify-between items-center text-lg py-2 rounded-lg px-3 bg-yellow-100">
                        <span class="font-bold text-yellow-800 flex items-center"><i data-lucide="briefcase" class="w-5 h-5 ml-2"></i> العمل/البزنس</span>
                        <span id="business-time-display" class="font-extrabold text-gray-800 text-xl">15:00</span>
                    </li>
                    <li class="flex justify-between items-center text-lg py-2 rounded-lg px-3 bg-blue-100">
                        <span class="font-bold text-blue-700 flex items-center"><i data-lucide="gamepad-2" class="w-5 h-5 ml-2"></i> الراحة/اللعب</span>
                        <span id="play-time-display" class="font-extrabold text-gray-800 text-xl">14:00</span>
                    </li>
                    <li class="flex justify-between items-center text-lg py-2 rounded-lg px-3 bg-green-100">
                        <span class="font-bold text-green-700 flex items-center"><i data-lucide="book-open" class="w-5 h-5 ml-2"></i> الدراسة المحددة</span>
                        <span id="study-range-display" class="font-extrabold text-gray-800 text-xl">18:00 - 21:00</span>
                    </li>
                </ul>
                <p class="mt-4 text-xs text-red-500 text-center">استخدم مؤقت الصرامة (50/10) في أوقات الدراسة المحددة.</p>
            </div>

        </div>
        
        <footer class="mt-12 text-center text-sm text-gray-500 border-t pt-4">
             <p>معرّف المستخدم (للحفظ): <span class="font-mono text-gray-700" id="user-id-display">N/A</span></p>
        </footer>

    </div>
    
    <script type="module">
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('user-id-display').textContent = user.uid;
            } else {
                document.getElementById('user-id-display').textContent = 'User not signed in.';
            }
        });
    </script>
</body>
</html>
